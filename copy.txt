from flask import Flask, request, jsonify
from flask_cors import CORS
from models import db, Manager
import random
import smtplib
from email.mime.text import MIMEText

app = Flask(__name__)

# Enable CORS for frontend communication
CORS(app)


otp_storage = {} 
# Configuring the SQLite database
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///managers.db'  # SQLite database file
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False  # Disable unnecessary tracking

# Initialize the database
db.init_app(app)

def send_otp(email, otp):
    msg = MIMEText(f"Your OTP for password reset is: {otp}")
    msg['Subject'] = 'Password Reset OTP'
    msg['From'] = 'your-email@example.com'
    msg['To'] = email

    # Send the message via your own SMTP server.
    with smtplib.SMTP('smtp.example.com') as server:
        server.login('your-email@example.com', 'your-email-password')
        server.sendmail(msg['From'], [msg['To']], msg.as_string())

@app.route('/api/signup', methods=['POST'])
def signup():
    data = request.json  # Get JSON data from the frontend
    print(request.json)  # To ensure data is received

    # Validate incoming data
    required_fields = ["firstName", "lastName", "email", "password", "confirmPassword", "role"]
    if not all(field in data for field in required_fields):
        return jsonify({"error": "All fields are required"}), 400

    # Check if passwords match
    if data['password'] != data['confirmPassword']:
        return jsonify({"error": "Passwords do not match"}), 400

    # Check if email already exists
    existing_manager = Manager.query.filter_by(email=data['email']).first()
    if existing_manager:
        return jsonify({"error": "Email already registered"}), 400

    # Create a new manager instance and save to database
    new_manager = Manager(
        first_name=data['firstName'],
        last_name=data['lastName'],
        email=data['email'],
        password=data['password'],  # In a real app, you'd hash the password!
        role=data['role']
    )

    db.session.add(new_manager)
    db.session.commit()

    return jsonify({"message": "Manager registered successfully"}), 201

@app.route('/api/login', methods=['POST'])
def login():
    data = request.json  # Get JSON data from the frontend

    # Validate incoming data
    required_fields = ["email", "password"]
    if not all(field in data for field in required_fields):
        return jsonify({"error": "Email and password are required"}), 400

    # Check if the user exists and the password is correct
    manager = Manager.query.filter_by(email=data['email']).first()
    if not manager or manager.password != data['password']:  # In a real app, you'd hash and verify the password!
        return jsonify({"error": "Invalid email or password"}), 401

    return jsonify({"message": "Login successful"}), 200

@app.route('/api/forgot-password', methods=['POST'])
def forgot_password():
    data = request.json  # Get JSON data from the frontend

    # Validate incoming data
    if 'email' not in data:
        return jsonify({"error": "Email is required"}), 400

    # Check if the user exists
    manager = Manager.query.filter_by(email=data['email']).first()
    if not manager:
        return jsonify({"error": "Email not registered"}), 400

    # Generate OTP
    otp = random.randint(100000, 999999)

    # Send OTP to user's email
    send_otp(manager.email, otp)

    return jsonify({"message": "OTP sent to your registered email"}), 200

'''
@app.route('/api/reset-password', methods=['POST'])
def reset_password():
    data = request.json  # Get JSON data from the frontend

    # Validate incoming data
    required_fields = ["email", "otp", "newPassword", "confirmNewPassword"]
    if not all(field in data for field in required_fields):
        return jsonify({"error": "All fields are required"}), 400

    # Check if passwords match
    if data['newPassword'] != data['confirmNewPassword']:
        return jsonify({"error": "Passwords do not match"}), 400

    # Validate email and OTP
    email = data['email']
    otp = data['otp']
    if email not in otp_storage or otp_storage[email] != otp:
        return jsonify({"error": "Invalid OTP"}), 400

    # Check if the user exists
    manager = Manager.query.filter_by(email=email).first()
    if not manager:
        return jsonify({"error": "Email not registered"}), 400

    # Update the password in the database
    manager.password = data['newPassword']  # In production, hash the password before storing it
    db.session.commit()

    # Clear OTP from storage after successful reset
    del otp_storage[email]

    return jsonify({"message": "Password has been reset successfully"}), 200
'''
if __name__ == "__main__":
    app.run(debug=True)
 